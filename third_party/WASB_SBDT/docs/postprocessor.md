
# Postprocessor

This document explains the role of the postprocessor in the WASB-SBDT pipeline.

## `TracknetV2Postprocessor`

The `TracknetV2Postprocessor` class is responsible for converting the raw heatmaps generated by the model into a list of potential ball coordinates. It takes the model's output and applies a series of processing steps to identify and locate the ball.

### `run(preds, affine_mats)`

This is the main method of the postprocessor. It takes the following arguments:

-   **`preds`**: The raw output (predictions) from the model. This is typically a tensor of heatmaps.
-   **`affine_mats`**: Affine transformation matrices used to map the coordinates from the model's output space back to the original image space.

**Returns:** A dictionary containing the detected ball candidates for each frame. Each candidate is represented by its coordinates (`xy`) and a confidence score.

## Detection Methods

The postprocessor uses one of two methods to detect ball candidates from the heatmaps, as specified in the configuration (`detector.postprocessor.blob_det_method`):

1.  **`_detect_blob_concomp` (Connected Components)**: This method thresholds the heatmap to create a binary image and then finds connected components (blobs). For each blob, it calculates the center of mass to determine the ball's coordinates. The score can be based on the size of the blob or the sum of the heatmap values within the blob.

2.  **`_detect_blob_nms` (Non-Maximum Suppression)**: This method iteratively finds the highest value in the heatmap, treats it as a detection, and then suppresses the surrounding region. This process is repeated until all values in the heatmap are below a certain threshold. This helps to avoid multiple detections of the same ball.

## Configuration

The behavior of the `TracknetV2Postprocessor` is controlled by the `detector.postprocessor` section of the configuration file. Key parameters include:

-   **`score_threshold`**: The minimum confidence score for a detection to be considered valid.
-   **`blob_det_method`**: The method to use for blob detection (`'concomp'` or `'nms'`).
-   **`use_hm_weight`**: If `True`, the heatmap values are used as weights when calculating the center of a blob. This can lead to more accurate localization.
