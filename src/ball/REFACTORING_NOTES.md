# Ball Detection Module Refactoring Notes

This document outlines the refactoring efforts undertaken to improve the scalability and maintainability of the ball detection model training and inference pipeline.

## 1. Motivation

Previously, each neural network model (`nn.Module`) had its own dedicated PyTorch Lightning Module (`LightningModule`). While functional, this approach led to code duplication for common training, validation, and optimization logic. Introducing new models required creating new `LightningModule` files, hindering rapid experimentation and scalability.

## 2. Refactoring Goals

*   **Decoupling**: Achieve a clear separation between the `nn.Module` (model architecture) and the `LightningModule` (training/optimization logic).
*   **Reusability**: Create a single, generic `LightningModule` that can train any `nn.Module` by injecting it as a dependency.
*   **Configurability**: Leverage Hydra to define model architectures, loss functions, optimizers, and training parameters entirely through configuration files, minimizing code changes for new experiments.
*   **Automation**: Develop a shell script to automate the sequential training of multiple models and the organized archiving of their best checkpoints.

## 3. Key Changes Implemented

### 3.1. Generic LightningModule (`LitGenericBallModel`)

*   **Location**: `src/ball/lit_module/lit_generic_ball_model.py`
*   **Description**: This new `LightningModule` is designed to be model-agnostic. It accepts an `nn.Module` instance, a `criterion` (loss function), `optimizer_params`, and `scheduler_params` in its constructor. It encapsulates the common training, validation, and test step logic, as well as optimizer and scheduler configuration.
*   **Impact**: Eliminates the need for model-specific `LightningModule` files, making the training codebase more concise and extensible.

### 3.2. Hydra Configuration Restructuring

*   **Location**: `configs/train/ball/`
*   **Description**: The configuration files have been reorganized to reflect the decoupling.
    *   `configs/train/ball/model/`: Contains YAML files defining only the `nn.Module` architecture (e.g., `lite_tracknet.yaml`, `conv3d_tsm_fpn.yaml`, `video_swin.yaml`).
    *   `configs/train/ball/lit_module/generic_focal_loss.yaml`: Defines the parameters for `LitGenericBallModel`, including the loss function and optimization settings. The `model` parameter is left as `null` or `???` to be injected later.
    *   Top-level experiment configs (e.g., `lite_tracknet_generic.yaml`, `conv3d_tsm_fpn.yaml`, `video_swin_generic.yaml`): These files use Hydra's `defaults` and `override` features to compose the `model` and `lit_module` components, injecting the specific `nn.Module` into `LitGenericBallModel`.
*   **Impact**: Enables highly flexible and reusable experiment definitions. Users can mix and match different models with various training strategies by simply modifying configuration files.

### 3.3. Training Script Adaptation (`src/ball/api/train.py`)

*   **Description**: The `main` function in `train.py` has been updated to instantiate `LitGenericBallModel` using the new configuration structure. Hydra's `instantiate` function now automatically resolves and injects the `nn.Module` and other dependencies into the generic `LightningModule`.
*   **Impact**: Simplifies the training entry point, as it no longer needs to handle different `LightningModule` types explicitly.

### 3.4. Inference Module Adaptation (`src/ball/ball_detection_module.py`)

*   **Description**: The `_load_model` method within `LiteTrackNetDetector` has been modified to use `LitGenericBallModel.load_from_checkpoint()`. This allows it to load checkpoints generated by the new training pipeline, regardless of the underlying `nn.Module` architecture.
*   **Impact**: Ensures forward compatibility with newly trained models. A fallback mechanism to load older, model-specific checkpoints has been temporarily included for backward compatibility during the transition phase.

### 3.5. Automated Training Script (`scripts/train/ball/train_all_models.sh`)

*   **Location**: `scripts/train/ball/train_all_models.sh`
*   **Description**: A new shell script has been created to automate the end-to-end training process for multiple models.
    *   It iterates through a predefined list of model configurations.
    *   For each model, it executes `python -m src.ball.api.train` with the appropriate Hydra config and a fixed output directory (`hydra.run.dir`).
    *   After successful training, it locates the `best_model.ckpt` within the Hydra output, moves it to a structured `checkpoints/ball/<model_name>/best_model.ckpt` path, and renames it.
*   **Impact**: Streamlines the training workflow, reduces manual intervention, and ensures consistent checkpoint organization.

### 3.6. Cleanup

*   **Description**: All redundant, model-specific `LightningModule` files (e.g., `lit_lite_tracknet_focal.py`, `lit_swin.py`, `lit_video_swin_transformer.py`, `lit_video_swin_transformer_focal.py`) have been removed from `src/ball/lit_module/`.
*   **Impact**: Reduces codebase size, improves clarity, and removes deprecated code paths.

## 4. Usage

### Training New Models

To train all configured models sequentially, navigate to the project root and run:

```bash
bash scripts/train/ball/train_all_models.sh
```

To train a specific model, use Hydra directly:

```bash
python -m src.ball.api.train --config-name=lite_tracknet_generic
# Or for Swin:
python -m src.ball.api.train --config-name=swin_generic
```

### Inference with New Checkpoints

Update the `model_path` in your inference script (e.g., `src/ball/example_usage.py` or `src/ball/ball_detection_module.py`) to point to the newly archived checkpoints:

```python
model_path = "checkpoints/ball/lite_tracknet_generic/best_model.ckpt"
# or
model_path = "checkpoints/ball/swin_generic/best_model.ckpt"

detector = create_ball_detection_module(
    model_path=model_path,
    device="auto",
    model_type="lite_tracknet" # This parameter might become less critical if generic loading is robust
)
```

## 5. Future Work

*   **Full Migration**: Once all existing models are retrained with the new system, the fallback loading mechanism in `src/ball/ball_detection_module.py` can be removed.
*   **Loss Function/Optimizer Configurability**: Further generalize `LitGenericBallModel` to accept more complex loss function compositions or optimizer/scheduler types directly from config, if needed.
*   **DataModule Integration**: Ensure all DataModules are compatible with the generic `LightningModule`'s input expectations.
