# PosePredictor - ポーズ推定予測器

## 概要
`PosePredictor` は、テニス試合におけるプレイヤーのポーズ（骨格）を推定する責任を持つ予測器です。物体検出（DETR）とポーズ推定（ViTPose）を組み合わせた2段階のパイプラインを採用し、プレイヤーの詳細な身体姿勢を17個のキーポイントで表現します。

## 主要な責任

### 1. 2段階推論パイプライン
- **物体検出**: DETRモデルによるプレイヤーの検出とバウンディングボックス抽出
- **ポーズ推定**: ViTPoseモデルによる各プレイヤーの17個キーポイント検出
- **統合処理**: 検出とポーズ推定結果の統合・整理
- **バッチ処理**: 複数フレームの効率的な同時処理

### 2. 前処理・後処理
- **RGB変換**: BGR→RGB変換による入力形式の統一
- **プロセッサ連携**: HuggingFace Transformersのprocessorとの統合
- **座標変換**: モデル出力座標の元画像解像度への変換
- **結果整理**: 検出・ポーズ情報の構造化されたフォーマット

### 3. 可視化・描画
- **スケルトン描画**: COCO形式の17個キーポイントとボーン接続の可視化
- **信頼度表示**: 各キーポイントの検出信頼度による可視化制御
- **バウンディングボックス**: プレイヤー検出範囲の表示
- **スコア表示**: 検出スコアとポーズスコアの併記

## 主要メソッド

### predict(frames: List[np.ndarray]) -> List[List[Dict]]
- フレーム群からプレイヤーのポーズを推定
- 戻り値: フレームごとのプレイヤーリスト
- 各プレイヤー情報: `{"bbox": [x0,y0,w,h], "det_score": float, "keypoints": [(x,y),...], "scores": [float,...]}`

### preprocess_detection(frames) -> Dict[str, torch.Tensor]
- 物体検出（DETR）用の前処理

### inference_detection(det_inputs) -> Dict[str, torch.Tensor]  
- DETR推論の実行

### postprocess_detection(det_outputs, frames) -> Tuple[...]
- DETR結果の後処理とViTPose用データ準備

### preprocess_pose(images, boxes) -> Dict[str, torch.Tensor]
- ポーズ推定（ViTPose）用の前処理

### inference_pose(pose_inputs) -> Dict[str, torch.Tensor]
- ViTPose推論の実行

### postprocess_pose(pose_outputs, ...) -> List[List[Dict]]
- ViTPose結果の後処理と最終フォーマット

### overlay(frame, detections) -> np.ndarray
- ポーズ情報をフレームに描画

## 設定パラメータ

- **player_label_id**: プレイヤーを表すラベルID（デフォルト: 0）
- **det_score_thresh**: 物体検出の信頼度閾値（デフォルト: 0.6）
- **pose_score_thresh**: ポーズ推定の信頼度閾値（デフォルト: 0.6）
- **device**: 推論デバイス（CPU/GPU）
- **use_half**: 半精度推論の有効化

## キーポイント構成（COCO形式）

17個のキーポイントでプレイヤーの全身を表現：

```
0: 鼻, 1: 左目, 2: 右目, 3: 左耳, 4: 右耳
5: 左肩, 6: 右肩, 7: 左肘, 8: 右肘, 9: 左手首, 10: 右手首  
11: 左腰, 12: 右腰, 13: 左膝, 14: 右膝, 15: 左足首, 16: 右足首
```

## スケルトン接続定義

16個のボーン接続でプレイヤーの骨格を表現：
- 顔部：鼻-目-耳の接続
- 上半身：肩-肘-手首の連結
- 胴体：肩-腰の接続
- 下半身：腰-膝-足首の連結

## 処理フロー

1. **物体検出段階**
   - 入力フレームからプレイヤーを検出
   - バウンディングボックスと検出スコアを取得
   - 閾値以上のプレイヤーのみを後段に送出

2. **ポーズ推定段階**
   - 検出されたプレイヤー領域からポーズを推定
   - 17個のキーポイント座標と信頼度を取得
   - 元画像座標系への変換

3. **結果統合**
   - 検出情報とポーズ情報の統合
   - フレーム単位での結果整理
   - 可視化用データの準備

## 使用場面

- テニスプレイヤーの動作解析
- ショットフォームの定量的評価  
- プレイヤーの動きパターン分析
- スポーツバイオメカニクス研究
- 戦術分析における選手位置・姿勢情報
- 自動コーチングシステムの基礎データ

## 連携する他の予測器

- **PlayerPredictor**: より詳細なプレイヤー検出として使用可能
- **EventPredictor**: プレイヤーポーズ情報をイベント検知の特徴量として使用
- **CourtPredictor**: コート座標系でのプレイヤー姿勢分析

## 技術的特徴

- **高精度な2段階推論**: 専門化されたモデルの組み合わせ
- **効率的なバッチ処理**: 複数フレーム・複数プレイヤーの同時処理
- **柔軟な信頼度制御**: 検出・ポーズ両方の閾値設定
- **詳細な可視化**: 骨格とキーポイントの直感的な表示
- **標準形式対応**: COCO形式による高い互換性 