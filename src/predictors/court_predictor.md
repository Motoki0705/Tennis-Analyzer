# CourtPredictor - コートキーポイント検出予測器

## 概要
`CourtPredictor` は、テニスコートのキーポイント（ライン交点、コーナーなど）を検出する責任を持つ予測器です。ヒートマップベースの検出手法を使用して、コートの重要な基準点を特定し、複数の可視化モードを提供します。

## 主要な責任

### 1. コートキーポイント検出
- **ヒートマップ推論**: 深層学習モデルを使用してキーポイントのヒートマップを生成
- **キーポイント抽出**: ヒートマップから局所最大点を検出してキーポイント座標を特定
- **マルチチャネル対応**: 単一チャネル・マルチチャネル両方のヒートマップ形式に対応
- **信頼度評価**: 各キーポイントに信頼度スコアを付与

### 2. 前処理・後処理
- **画像正規化**: Albumentationsを使用した標準的な前処理パイプライン
- **解像度変換**: モデル入力サイズ（256x256）への変換と元解像度への復元
- **シグモイド変換**: ヒートマップの確率値への変換
- **NMS処理**: 近接するキーポイントの重複除去

### 3. 可視化モード
- **overlay**: キーポイントを円で描画するシンプルな可視化
- **heatmap**: ヒートマップをカラーマップで重ね合わせた可視化
- **heatmap_channels**: マルチチャネルヒートマップの統合表示

## 主要メソッド

### predict(frames: List[np.ndarray]) -> Tuple[List[List[Dict]], List[np.ndarray]]
- フレーム群からキーポイントを検出
- 戻り値: キーポイント情報とヒートマップのタプル
- キーポイント形式: `[{"x": int, "y": int, "confidence": float}]`

### overlay(frame: np.ndarray, keypoints: List[Dict]) -> np.ndarray
- キーポイントを円で描画
- 信頼度が閾値以上のキーポイントのみを可視化

### overlay_heatmap(frame: np.ndarray, hm: np.ndarray) -> np.ndarray
- ヒートマップをカラーマップで重ね合わせ
- αブレンディングによる透明度調整

### run(input_path, output_path, batch_size=8)
- 動画ファイル全体を処理し、可視化結果を動画出力
- 複数の可視化モードから選択可能

## 設定パラメータ

- **input_size**: モデル入力サイズ（デフォルト: 256x256）
- **num_keypoints**: 検出するキーポイント数（デフォルト: 15）
- **threshold**: キーポイント信頼度閾値（デフォルト: 0.5）
- **visualize_mode**: 可視化モード（overlay/heatmap/heatmap_channels）
- **radius**: キーポイント描画時の円の半径
- **kp_color**: キーポイントの描画色

## キーポイント検出手法

### 単一チャネル方式
- 1つのヒートマップから複数のキーポイントを検出
- 局所最大点の検出とNMS処理による重複除去
- 従来の一般的な手法

### マルチチャネル方式
- キーポイントごとに専用チャネルを持つヒートマップ
- 各チャネルの最大値位置を直接キーポイントとして使用
- より高精度な検出が可能

## 使用場面

- テニスコートの幾何学的基準点の自動検出
- カメラキャリブレーション用の基準点提供
- コート座標系の確立
- 選手・ボール位置のコート相対座標への変換
- 試合分析における空間情報の提供

## 連携する他の予測器

- **BallPredictor**: ボール位置のコート相対座標化
- **PlayerPredictor**: プレイヤー位置のコート相対座標化
- **EventPredictor**: コート情報をイベント検知の特徴量として使用

## 技術的特徴

- **効率的な処理**: バッチ処理による高速化
- **メモリ最適化**: 半精度推論オプション
- **柔軟な可視化**: 用途に応じた複数の表示モード
- **高い堅牢性**: 複数の検出手法への対応 