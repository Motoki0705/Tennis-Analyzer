# BallPredictor - ボール追跡予測器

## 概要
`BallPredictor` は、テニス試合におけるボールの位置を時系列で追跡する責任を持つ予測器です。複数フレームを入力とし、TrackNet系のモデルを使用してボールの軌道を予測・トラッキングします。ヒートマップベースの検出と座標回帰の両方に対応し、軌道の平滑化機能も提供します。

## 主要な責任

### 1. ボール位置検出・追跡
- **時系列処理**: 連続する複数フレームからボールの位置を予測
- **軌道追跡**: フレーム間でのボールの移動軌道を一貫して追跡
- **複数推論方式**: ヒートマップベースと座標回帰の両方式に対応
- **StreamingOverlayer対応**: リアルタイム処理への対応

### 2. 軌道後処理
- **外れ値除去**: 急激な位置変化（ジャンプ）の検出と除去
- **軌道補間**: 欠損したボール位置の線形補間による復元
- **平滑化処理**: ノイズの多い軌道データの平滑化
- **信頼度評価**: 各検出結果に信頼度スコアを付与

### 3. 可視化・分析
- **特徴マップ可視化**: 中間層の特徴マップを可視化
- **ヒートマップ表示**: ボール位置の確率分布を可視化
- **軌道描画**: ボールの移動軌跡をフレームに描画
- **デバッグ情報**: 詳細な解析情報の提供

## 主要メソッド

### predict(clips: List[List[np.ndarray]]) -> List[dict]
- クリップ（複数フレーム）からボール位置を予測
- 戻り値: `[{"x": int, "y": int, "confidence": float}]` のリスト

### inference(tensor_data)
- StreamingOverlayer対応の推論メソッド
- フレームリストとテンソル両方の入力形式に対応

### extract_features(clips: List[List[np.ndarray]]) -> torch.Tensor
- 中間特徴の抽出（可視化・分析用）

### visualize_features(feats: List[torch.Tensor], original_size) -> List[np.ndarray]
- 特徴マップの可視化

### remove_jumps(track, max_dist=80)
- 軌道の外れ値除去（静的メソッド）

### interpolate_track(track)
- 欠損位置の補間（静的メソッド）

## 設定パラメータ

- **input_size**: モデル入力サイズ
- **heatmap_size**: ヒートマップの解像度
- **num_frames**: 1クリップあたりのフレーム数（通常3）
- **threshold**: 検出信頼度閾値（デフォルト: 0.6）
- **visualize_mode**: 可視化モード選択
- **feature_layer**: 特徴抽出対象層
- **use_half**: 半精度推論の有効化

## 推論方式

### ヒートマップベース
- ボール位置の確率分布をヒートマップで表現
- シグモイド関数適用後、最大値位置を検出
- 信頼度としてヒートマップの最大値を使用

### 座標回帰ベース
- ボール位置を直接座標値として回帰
- 正規化座標[0,1]を元画像座標に変換
- 信頼度情報は提供されない（None）

## 軌道後処理アルゴリズム

### 外れ値除去（remove_jumps）
- 連続フレーム間の距離を計算
- 設定距離（max_dist）を超える急激な移動を検出
- 外れ値をNoneに置換して除去

### 軌道補間（interpolate_track）
- 欠損位置（None）を線形補間で復元
- numpy.nanを使用した効率的な補間処理
- 軌道の連続性を保持

## 使用場面

- テニス試合におけるボールの自動追跡
- ボール軌道の定量的分析
- ショット解析の基礎データ提供
- リアルタイムトラッキングシステム
- 試合ハイライト抽出の判断材料

## 連携する他の予測器

- **EventPredictor**: ボール位置情報をイベント検知の主要特徴量として使用
- **CourtPredictor**: コート座標系でのボール位置表現
- **PlayerPredictor**: プレイヤーとボールの相対位置分析

## 技術的特徴

- **時系列モデリング**: 複数フレームの時間的関係を活用
- **柔軟な入力形式**: 固定クリップとストリーミング両対応
- **堅牢な後処理**: 実際の試合環境でのノイズに対応
- **効率的な処理**: バッチ処理と半精度推論による高速化
- **詳細な可視化**: 中間結果の確認とデバッグ支援 